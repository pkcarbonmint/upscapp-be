version: '3.8'

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - STRAPI_URL=${STRAPI_URL}
      - HELIOS_SERVER_URL=${HELIOS_SERVER_URL}
      - ENVIRONMENT=${ENVIRONMENT}
    depends_on:
      - helios
    restart: unless-stopped
    command: ["python", "src/main.py"]
    volumes:
      - ./logs:/app/logs

  helios:
    build:
      context: ./helios
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      - PORT=8080
      - ENVIRONMENT=${ENVIRONMENT}
    restart: unless-stopped
    command: ["python", "main.py"]
    volumes:
      - ./helios/logs:/app/logs

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "3000:80"
    environment:
      - REACT_APP_API_URL=${REACT_APP_API_URL}
      - REACT_APP_HELIOS_URL=${REACT_APP_HELIOS_URL}
    restart: unless-stopped
    depends_on:
      - app

  onboarding-ui:
    build:
      context: ./onboarding-ui
      dockerfile: Dockerfile
    ports:
      - "3001:80"
    environment:
      - REACT_APP_API_URL=${REACT_APP_API_URL}
      - REACT_APP_HELIOS_URL=${REACT_APP_HELIOS_URL}
    restart: unless-stopped
    depends_on:
      - app

  faculty-ui:
    build:
      context: ./faculty-ui
      dockerfile: Dockerfile
    ports:
      - "3002:80"
    environment:
      - REACT_APP_API_URL=${REACT_APP_API_URL}
      - REACT_APP_HELIOS_URL=${REACT_APP_HELIOS_URL}
    restart: unless-stopped
    depends_on:
      - app

  celery:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - ENVIRONMENT=${ENVIRONMENT}
    restart: unless-stopped
    command: ["celery", "-A", "src.tasks.celery_tasks", "worker", "-l", "INFO", "-E", "--concurrency=2"]
    depends_on:
      - app
    volumes:
      - ./logs:/app/logs

  flower:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "5555:5555"
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - ENVIRONMENT=${ENVIRONMENT}
    restart: unless-stopped
    command: ["celery", "-A", "src.tasks.celery_tasks", "flower", "--port=5555"]
    depends_on:
      - celery

  webhook:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "9000:9000"
    environment:
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - GITHUB_REPOSITORY_URL=${GITHUB_REPOSITORY_URL}
      - GITHUB_BRANCH=${GITHUB_BRANCH}
      - WEBHOOK_SECRET=${WEBHOOK_SECRET}
      - ENABLE_AUTO_DEPLOY=${ENABLE_AUTO_DEPLOY}
    restart: unless-stopped
    command: ["python", "scripts/webhook_server.py"]
    depends_on:
      - app
    volumes:
      - ./logs:/app/logs

networks:
  default:
    driver: bridge
