import { createPlanForOneWeek, Config } from './OneWeekPlan';
import type { StudentIntake } from '../types/models';
import type { Subject } from '../types/Subjects';
import { makeLogger } from '../services/Log';

describe('OneWeekPlan - Catchup Day Tests', () => {
  const mockSubject: Subject = {
    subjectCode: 'H01',
    subjectName: 'History-Ancient',
    baselineHours: 25,
    examFocus: 'BothExams',
    topics: [
      {
        topicCode: 'T001',
        topicName: 'Indus Valley Civilization',
        priority: 'A',
        baselineHours: 5,
        subtopics: []
      },
      {
        topicCode: 'T002', 
        topicName: 'Vedic Period',
        priority: 'A',
        baselineHours: 5,
        subtopics: []
      }
    ]
  };

  const mockArchetype = {
    archetype: 'Balanced',
    timeCommitment: 'FullTime' as const,
    weeklyHoursMin: 40,
    weeklyHoursMax: 60,
    description: 'Balanced study approach',
    defaultPacing: 'Balanced' as const,
    defaultApproach: 'SingleSubject' as const
  };

  const baseConfig: Config = {
    daily_hour_limits: {
      regular_day: 8,
      catch_up_day: 10,
      test_day: 6
    },
    task_effort_split: {
      study: 0.6,
      practice: 0.2,
      revision: 0.15,
      test: 0.05
    }
  };

  const logger = makeLogger([]);

  describe('Catchup Day Assignment', () => {
    test('should assign Sunday as catchup day when student prefers Sunday', async () => {
      const studentIntake: StudentIntake = {
        subject_confidence: { H01: 'Moderate' },
        study_strategy: {
          study_focus_combo: 'GSPlusOptionalPlusCSAT',
          weekly_study_hours: '50',
          time_distribution: 'Balanced',
          study_approach: 'Balanced',
          revision_strategy: 'Weekly',
          test_frequency: 'Weekly',
          seasonal_windows: ['Foundation', 'Revision'],
          catch_up_day_preference: 'Sunday'
        },
        start_date: '2024-01-01'
      };

      const weeklyPlan = await createPlanForOneWeek(
        0,
        [mockSubject],
        studentIntake,
        mockArchetype,
        baseConfig,
        1,
        1,
        logger
      );

      // Check that Sunday (day 7) has more hours than regular days
      const sundayPlan = weeklyPlan.daily_plans.find(day => day.day === 7);
      const regularDayPlan = weeklyPlan.daily_plans.find(day => day.day === 1);

      expect(sundayPlan).toBeDefined();
      expect(regularDayPlan).toBeDefined();

      const sundayHours = sundayPlan!.tasks.reduce((sum, task) => sum + task.duration_minutes, 0) / 60;
      const regularDayHours = regularDayPlan!.tasks.reduce((sum, task) => sum + task.duration_minutes, 0) / 60;

      // Sunday should have more hours (catchup day limit is 10 vs 8 for regular days)
      expect(sundayHours).toBeGreaterThan(regularDayHours);
      expect(sundayHours).toBeLessThanOrEqual(10); // Should not exceed catchup day limit
    });

    test('should assign Saturday as catchup day when student prefers Saturday', async () => {
      const studentIntake: StudentIntake = {
        subject_confidence: { H01: 'Moderate' },
        study_strategy: {
          study_focus_combo: 'GSPlusOptionalPlusCSAT',
          weekly_study_hours: '50',
          time_distribution: 'Balanced',
          study_approach: 'Balanced',
          revision_strategy: 'Weekly',
          test_frequency: 'Weekly',
          seasonal_windows: ['Foundation', 'Revision'],
          catch_up_day_preference: 'Saturday'
        },
        start_date: '2024-01-01'
      };

      const weeklyPlan = await createPlanForOneWeek(
        0,
        [mockSubject],
        studentIntake,
        mockArchetype,
        baseConfig,
        1,
        1,
        logger
      );

      // Check that Saturday (day 6) has more hours than regular days
      const saturdayPlan = weeklyPlan.daily_plans.find(day => day.day === 6);
      const regularDayPlan = weeklyPlan.daily_plans.find(day => day.day === 1);

      expect(saturdayPlan).toBeDefined();
      expect(regularDayPlan).toBeDefined();

      const saturdayHours = saturdayPlan!.tasks.reduce((sum, task) => sum + task.duration_minutes, 0) / 60;
      const regularDayHours = regularDayPlan!.tasks.reduce((sum, task) => sum + task.duration_minutes, 0) / 60;

      // Saturday should have more hours (catchup day)
      expect(saturdayHours).toBeGreaterThan(regularDayHours);
      expect(saturdayHours).toBeLessThanOrEqual(10); // Should not exceed catchup day limit
    });

    test('should default to Saturday when no catchup day preference is specified', async () => {
      const studentIntake: StudentIntake = {
        subject_confidence: { H01: 'Moderate' },
        study_strategy: {
          study_focus_combo: 'GSPlusOptionalPlusCSAT',
          weekly_study_hours: '50',
          time_distribution: 'Balanced',
          study_approach: 'Balanced',
          revision_strategy: 'Weekly',
          test_frequency: 'Weekly',
          seasonal_windows: ['Foundation', 'Revision'],
          catch_up_day_preference: '' // Empty preference
        },
        start_date: '2024-01-01'
      };

      const weeklyPlan = await createPlanForOneWeek(
        0,
        [mockSubject],
        studentIntake,
        mockArchetype,
        baseConfig,
        1,
        1,
        logger
      );

      // Check that Saturday (day 6) has more hours (default catchup day)
      const saturdayPlan = weeklyPlan.daily_plans.find(day => day.day === 6);
      const regularDayPlan = weeklyPlan.daily_plans.find(day => day.day === 1);

      expect(saturdayPlan).toBeDefined();
      expect(regularDayPlan).toBeDefined();

      const saturdayHours = saturdayPlan!.tasks.reduce((sum, task) => sum + task.duration_minutes, 0) / 60;
      const regularDayHours = regularDayPlan!.tasks.reduce((sum, task) => sum + task.duration_minutes, 0) / 60;

      // Saturday should have more hours (default catchup day)
      expect(saturdayHours).toBeGreaterThan(regularDayHours);
    });
  });

  describe('Day Limits Enforcement', () => {
    test('should not exceed catchup day hour limit', async () => {
      const studentIntake: StudentIntake = {
        subject_confidence: { H01: 'Moderate' },
        study_strategy: {
          study_focus_combo: 'GSPlusOptionalPlusCSAT',
          weekly_study_hours: '70', // High weekly hours to test limits
          time_distribution: 'Balanced',
          study_approach: 'Balanced',
          revision_strategy: 'Weekly',
          test_frequency: 'Weekly',
          seasonal_windows: ['Foundation', 'Revision'],
          catch_up_day_preference: 'Sunday'
        },
        start_date: '2024-01-01'
      };

      const weeklyPlan = await createPlanForOneWeek(
        0,
        [mockSubject],
        studentIntake,
        mockArchetype,
        baseConfig,
        1,
        1,
        logger
      );

      // Check all days don't exceed their respective limits
      weeklyPlan.daily_plans.forEach(dayPlan => {
        const dayHours = dayPlan.tasks.reduce((sum, task) => sum + task.duration_minutes, 0) / 60;
        
        if (dayPlan.day === 7) { // Sunday - catchup day
          expect(dayHours).toBeLessThanOrEqual(10);
        } else if (dayPlan.day === 6) { // Saturday - test day
          expect(dayHours).toBeLessThanOrEqual(6);
        } else { // Regular days
          expect(dayHours).toBeLessThanOrEqual(8);
        }
      });
    });

    test('should distribute tasks across all 7 days', async () => {
      const studentIntake: StudentIntake = {
        subject_confidence: { H01: 'Moderate' },
        study_strategy: {
          study_focus_combo: 'GSPlusOptionalPlusCSAT',
          weekly_study_hours: '50',
          time_distribution: 'Balanced',
          study_approach: 'Balanced',
          revision_strategy: 'Weekly',
          test_frequency: 'Weekly',
          seasonal_windows: ['Foundation', 'Revision'],
          catch_up_day_preference: 'Sunday'
        },
        start_date: '2024-01-01'
      };

      const weeklyPlan = await createPlanForOneWeek(
        0,
        [mockSubject],
        studentIntake,
        mockArchetype,
        baseConfig,
        1,
        1,
        logger
      );

      // Should have exactly 7 days
      expect(weeklyPlan.daily_plans).toHaveLength(7);
      
      // Each day should have tasks
      weeklyPlan.daily_plans.forEach(dayPlan => {
        expect(dayPlan.tasks.length).toBeGreaterThan(0);
        expect(dayPlan.day).toBeGreaterThanOrEqual(1);
        expect(dayPlan.day).toBeLessThanOrEqual(7);
      });

      // Days should be in order
      const dayNumbers = weeklyPlan.daily_plans.map(day => day.day);
      expect(dayNumbers).toEqual([1, 2, 3, 4, 5, 6, 7]);
    });
  });

  describe('Task Type Distribution', () => {
    test('should generate different task types based on config', async () => {
      const studentIntake: StudentIntake = {
        subject_confidence: { H01: 'Moderate' },
        study_strategy: {
          study_focus_combo: 'GSPlusOptionalPlusCSAT',
          weekly_study_hours: '50',
          time_distribution: 'Balanced',
          study_approach: 'Balanced',
          revision_strategy: 'Weekly',
          test_frequency: 'Weekly',
          seasonal_windows: ['Foundation', 'Revision'],
          catch_up_day_preference: 'Sunday'
        },
        start_date: '2024-01-01'
      };

      const weeklyPlan = await createPlanForOneWeek(
        0,
        [mockSubject],
        studentIntake,
        mockArchetype,
        baseConfig,
        1,
        1,
        logger
      );

      // Collect all tasks and their types
      const allTasks = weeklyPlan.daily_plans.flatMap(day => day.tasks);
      const taskTypes = allTasks.map(task => task.taskType).filter(Boolean);

      // Should have multiple task types (study, practice, revision, test)
      const uniqueTaskTypes = [...new Set(taskTypes)];
      expect(uniqueTaskTypes.length).toBeGreaterThan(1);
      
      // Should include study tasks
      expect(uniqueTaskTypes).toContain('study');
      
      // Should include other task types based on config
      expect(uniqueTaskTypes.some(type => ['practice', 'revision', 'test'].includes(type))).toBe(true);
    });
  });

  describe('Catchup Day vs Test Day Separation', () => {
    test('should assign different days for catchup and test when both are specified', async () => {
      const studentIntake: StudentIntake = {
        subject_confidence: { H01: 'Moderate' },
        study_strategy: {
          study_focus_combo: 'GSPlusOptionalPlusCSAT',
          weekly_study_hours: '50',
          time_distribution: 'Balanced',
          study_approach: 'Balanced',
          revision_strategy: 'Weekly',
          test_frequency: 'Weekly',
          seasonal_windows: ['Foundation', 'Revision'],
          catch_up_day_preference: 'Sunday'
        },
        start_date: '2024-01-01'
      };

      const weeklyPlan = await createPlanForOneWeek(
        0,
        [mockSubject],
        studentIntake,
        mockArchetype,
        baseConfig,
        1,
        1,
        logger
      );

      // Sunday should be catchup day (more hours)
      const sundayPlan = weeklyPlan.daily_plans.find(day => day.day === 7);
      const saturdayPlan = weeklyPlan.daily_plans.find(day => day.day === 6);

      expect(sundayPlan).toBeDefined();
      expect(saturdayPlan).toBeDefined();

      const sundayHours = sundayPlan!.tasks.reduce((sum, task) => sum + task.duration_minutes, 0) / 60;
      const saturdayHours = saturdayPlan!.tasks.reduce((sum, task) => sum + task.duration_minutes, 0) / 60;

      // Sunday (catchup day) should have more hours than Saturday (test day)
      expect(sundayHours).toBeGreaterThan(saturdayHours);
    });
  });
});
