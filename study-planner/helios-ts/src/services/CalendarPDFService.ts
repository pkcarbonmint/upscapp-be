
import type { StudyPlan, StudentIntake } from '../types/models';
import { CycleType } from '../types/Types';
import { ResourceService } from './ResourceService';
import { SubjectLoader } from './SubjectLoader';
import dayjs from 'dayjs';
import isBetween from 'dayjs/plugin/isBetween';
import isSameOrBefore from 'dayjs/plugin/isSameOrBefore';
dayjs.extend(isBetween);
dayjs.extend(isSameOrBefore);
import puppeteer, { type PDFOptions, type Browser } from 'puppeteer';

// Color mapping for different cycle types (matching the original PDFService)
const CYCLE_TYPE_COLORS = {
  [CycleType.C1]: { bg: 'rgb(227, 242, 253)', border: 'rgb(59, 130, 246)' }, // Very light blue
  [CycleType.C2]: { bg: 'rgb(232, 245, 232)', border: 'rgb(34, 197, 94)' }, // Very light green  
  [CycleType.C3]: { bg: 'rgb(252, 228, 236)', border: 'rgb(236, 72, 153)' }, // Very light pink
  [CycleType.C4]: { bg: 'rgb(255, 235, 238)', border: 'rgb(239, 68, 68)' }, // Very light red
  [CycleType.C5]: { bg: 'rgb(243, 229, 245)', border: 'rgb(168, 85, 247)' }, // Very light purple
  [CycleType.C5B]: { bg: 'rgb(243, 229, 245)', border: 'rgb(168, 85, 247)' }, // Very light purple
  [CycleType.C6]: { bg: 'rgb(225, 245, 254)', border: 'rgb(6, 182, 212)' }, // Very light cyan
  [CycleType.C7]: { bg: 'rgb(255, 243, 224)', border: 'rgb(245, 158, 11)' }, // Very light orange
  [CycleType.C8]: { bg: 'rgb(241, 248, 233)', border: 'rgb(132, 204, 22)' }, // Very light lime
} as const;

/**
 * Generate structured PDF that matches Word document format with high-fidelity rendering
 * This is the RECOMMENDED method for professional study plan PDFs
 */
async function generateStructuredPDF(
  studyPlan: StudyPlan,
  studentIntake: StudentIntake,
  filename?: string
): Promise<void> {
  try {
    // Create high-quality HTML template
    const htmlContent = await createStructuredHTML(studyPlan, studentIntake);

    // Generate PDF using Puppeteer
    const pdfBuffer = await generatePDFFromHTML(htmlContent, {
      format: 'A4',
      printBackground: true,
      margin: { top: '20px', right: '30px', bottom: '20px', left: '30px' },
      preferCSSPageSize: false,
      displayHeaderFooter: true,
      headerTemplate: '<div></div>',
      footerTemplate: `
        <div style="font-size: 10px; text-align: center; width: 100%; color: #666; margin: 0 15px;">
          <span class="title"></span> - Generated by Helios Study Planner on ${new Date().toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      })} - Page <span class="pageNumber"></span> of <span class="totalPages"></span>
        </div>
      `
    });

    // Save the PDF
    await savePDF(pdfBuffer, filename || `study-plan-${studyPlan.study_plan_id || 'plan'}.pdf`);

  } catch (error) {
    console.error('Failed to generate structured PDF:', error);
    throw new Error('Structured PDF generation failed');
  }
}

/**
 * Main entry point - defaults to structured PDF (recommended)
 * Matches the exact interface of the original PDFService
 */
export class CalendarPDFService {
  static async generateStudyPlanPDF(
    studyPlan: StudyPlan,
    studentIntake: StudentIntake,
    options: {
      filename: string;
    }
  ): Promise<void> {
      return generateStructuredPDF(studyPlan, studentIntake, options?.filename);
  }

  public static async generateHTML(studyPlan: StudyPlan, studentIntake: StudentIntake,
    options: {
      filename: string;
    }
  ): Promise<string> {
    const htmlContent = await createStructuredHTML(studyPlan, studentIntake);
    // write to file
    const fs = await import('fs');
    const path = await import('path');
    const outputDir = path.join(process.cwd(), 'generated-docs');
    const outputPath = path.join(outputDir, options.filename);
    fs.writeFileSync(outputPath, htmlContent);
    return htmlContent;
  }
}

// ===== CORE PDF GENERATION METHODS =====

/**
 * Generate PDF from HTML using Puppeteer with high-quality settings
 */
async function generatePDFFromHTML(htmlContent: string, options: PDFOptions): Promise<Buffer> {
  let browser: Browser | null = null;

  try {
    // Launch browser with optimized settings for PDF generation
    browser = await puppeteer.launch({
      headless: true,
      args: [
        '--no-sandbox',
        '--disable-setuid-sandbox',
        '--disable-dev-shm-usage',
        '--disable-gpu',
        '--disable-web-security',
        '--disable-features=VizDisplayCompositor',
        '--run-all-compositor-stages-before-draw',
        '--disable-extensions-http-throttling'
      ],
      // Use system Chrome if available for better font rendering
      executablePath: process.env.CHROME_PATH || undefined
    });

    const page = await browser.newPage();

    // Set viewport for consistent rendering
    await page.setViewport({ width: 1200, height: 1600, deviceScaleFactor: 2 });

    // Enable better font rendering
    await page.evaluateOnNewDocument(() => {
      // Improve text rendering
      const style = document.createElement('style');
      style.innerHTML = `
          * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
          }
        `;
      document.head.appendChild(style);
    });

    // Set content with proper encoding
    await page.setContent(htmlContent, {
      waitUntil: ['networkidle0', 'domcontentloaded'],
      timeout: 30000
    });

    // Wait for any charts or dynamic content to load
    await new Promise(resolve => setTimeout(resolve, 2000));

    // Generate PDF with high-quality settings
    const pdfBuffer = await page.pdf({
      ...options,
      preferCSSPageSize: false,
      printBackground: true
    });

    return Buffer.from(pdfBuffer);
  } finally {
    if (browser) {
      await browser.close();
    }
  }
}

/**
 * Save PDF to appropriate location (filesystem or browser download)
 */
async function savePDF(pdfBuffer: Buffer, filename: string): Promise<void> {
  if (typeof window !== 'undefined') {
    // Browser environment - trigger download
    const blob = new Blob([new Uint8Array(pdfBuffer)], { type: 'application/pdf' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
    console.log(`üìÅ PDF download triggered: ${filename}`);
  } else {
    // Node.js environment - save to filesystem
    const fs = await import('fs');
    const path = await import('path');

    const outputDir = path.join(process.cwd(), 'generated-docs');

    // Ensure output directory exists
    if (!fs.existsSync(outputDir)) {
      fs.mkdirSync(outputDir, { recursive: true });
    }

    const outputPath = path.join(outputDir, filename);
    fs.writeFileSync(outputPath, pdfBuffer);

    console.log(`‚úÖ PDF saved: ${filename}`);
    console.log(`   üìÅ Location: ${outputPath}`);
  }
}

// ===== HTML TEMPLATE GENERATION METHODS =====

/**
 * Create structured HTML template that matches Word document format
 */
async function createVisualHTML(studyPlan: StudyPlan, studentIntake: StudentIntake): Promise<string> {
  // For now, use the same as structured HTML
  return createStructuredHTML(studyPlan, studentIntake);
}

async function createStructuredHTML(studyPlan: StudyPlan, studentIntake: StudentIntake): Promise<string> {
  const year = studyPlan.targeted_year || new Date().getFullYear();

  return `
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Study Planner Calendar - ${year}</title>
        ${getStructuredCSS()}
    </head>
    <body>
        <div class="container">
            ${generateCalendarHeader(year, studentIntake)}
            
            <div class="calendar-section">
            ${generateBirdsEyeView(studyPlan)}
            ${generateMonthView(studyPlan)}
            ${generateWeekView(studyPlan)}
            ${await generateResourcesTable(studyPlan)}
            ${generateLegend(studyPlan)}
            </div>
            ${generateStudentProfile(studentIntake)}
        </div>
    </body>
    </html>`;
}



function generateCalendarHeader(year: number, studentIntake: StudentIntake): string {
  return `
    <div class="header">
        <h1><i class="fas fa-calendar-alt"></i> Study Planner Calendar ${year}</h1>
        <p>Personalized UPSC Preparation Plan for ${studentIntake.personal_details?.full_name || 'N/A'}</p>
    </div>`;
}

function generateStudentProfile(studentIntake: StudentIntake): string {
  const pd = studentIntake.personal_details;
  const ss = studentIntake.study_strategy;
  const ps = studentIntake.preparation_background;

  return `
    <div class="student-profile">
        <div class="profile-header">
            <div class="profile-title">Student Profile</div>
            <div class="profile-subtitle">UPSC ${studentIntake.target_year} Preparation Plan</div>
        </div>
        
        <div class="profile-grid">
            <div class="profile-card">
                <div class="profile-card-title">üë§ Personal Details</div>
                <div class="profile-item">
                    <span class="profile-label">Full Name:</span>
                    <span class="profile-value">${pd?.full_name || 'N/A'}</span>
                </div>
                <div class="profile-item">
                    <span class="profile-label">Email:</span>
                    <span class="profile-value">${pd?.email || 'N/A'}</span>
                </div>
                <div class="profile-item">
                    <span class="profile-label">Phone:</span>
                    <span class="profile-value">${pd?.phone_number || 'N/A'}</span>
                </div>
                <div class="profile-item">
                    <span class="profile-label">Location:</span>
                    <span class="profile-value">${pd?.present_location || 'N/A'}</span>
                </div>
            </div>
            
            <div class="profile-card">
                <div class="profile-card-title">üéì Academic Background</div>
                <div class="profile-item">
                    <span class="profile-label">Graduation:</span>
                    <span class="profile-value">${pd?.graduation_stream || 'N/A'}</span>
                </div>
                <div class="profile-item">
                    <span class="profile-label">College:</span>
                    <span class="profile-value">${pd?.college_university || 'N/A'}</span>
                </div>
                <div class="profile-item">
                    <span class="profile-label">Year of Passing:</span>
                    <span class="profile-value">${pd?.year_of_passing || 'N/A'}</span>
                </div>
                <div class="profile-item">
                    <span class="profile-label">Student Type:</span>
                    <span class="profile-value">${pd?.student_archetype || 'N/A'}</span>
                </div>
            </div>
            
            <div class="profile-card">
                <div class="profile-card-title">üìö Study Strategy</div>
                <div class="profile-item">
                    <span class="profile-label">Weekly Hours:</span>
                    <span class="profile-value">${ss?.weekly_study_hours || 'N/A'} hours</span>
                </div>
                <div class="profile-item">
                    <span class="profile-label">Study Approach:</span>
                    <span class="profile-value">${ss?.study_approach || 'N/A'}</span>
                </div>
                <div class="profile-item">
                    <span class="profile-label">Focus Combo:</span>
                    <span class="profile-value">${ss?.study_focus_combo || 'N/A'}</span>
                </div>
                <div class="profile-item">
                    <span class="profile-label">Optional Subject:</span>
                    <span class="profile-value">${studentIntake.optional_subject?.optional_subject_name || 'N/A'}</span>
                </div>
            </div>
            
            <div class="profile-card">
                <div class="profile-card-title">üéØ Preparation Status</div>
                <div class="profile-item">
                    <span class="profile-label">Preparing Since:</span>
                    <span class="profile-value">${ps?.preparing_since || 'N/A'}</span>
                </div>
                <div class="profile-item">
                    <span class="profile-label">Previous Attempts:</span>
                    <span class="profile-value">${ps?.number_of_attempts || 'N/A'}</span>
                </div>
                <div class="profile-item">
                    <span class="profile-label">Target Year:</span>
                    <span class="profile-value">${studentIntake.target_year || 'N/A'}</span>
                </div>
                <div class="profile-item">
                    <span class="profile-label">Start Date:</span>
                    <span class="profile-value">${studentIntake.start_date || 'N/A'}</span>
                </div>
            </div>
        </div>
    </div>`;
}

async function generateResourcesTable(studyPlan: StudyPlan): Promise<string> {
  const uniqueSubjects = getUniqueSubjects(studyPlan);
  let html = `
    <div class="resources-table-section">
        <div class="resources-table-title">
            <i class="fas fa-table"></i>
            Comprehensive Resources by Subject
        </div>
        
        <table class="subject-resources-table">
            <thead>
                <tr>
                    <th>Subject</th>
                    <th>Primary Books</th>
                    <th>Video Content</th>
                    <th>Practice Materials</th>
                    <th>Current Affairs</th>
                </tr>
            </thead>
            <tbody>
    `;

  for (const subjectCode of uniqueSubjects) {
    const subjectName = getSubjectName(subjectCode);
    const resources = await ResourceService.getResourcesForSubject(subjectCode);

    html += `
      <tr>
          <td class="subject-name">${subjectName}</td>
          <td>
              ${resources.primary_books.map(r => `<div class="resource-list-item">${r.resource_title}</div>`).join('')}
          </td>
          <td>
              ${resources.video_content.map(r => `<div class="resource-list-item">${r.resource_title}</div>`).join('')}
          </td>
          <td>
              ${resources.practice_resources.map(r => `<div class="resource-list-item">${r.resource_title}</div>`).join('')}
          </td>
          <td>
              ${resources.current_affairs_sources.map(r => `<div class="resource-list-item">${r.resource_title}</div>`).join('')}
          </td>
      </tr>
      `;
  }

  html += `
            </tbody>
        </table>
    </div>
    `;

  return html;
}

function generateLegend(studyPlan: StudyPlan): string {
  const cycles = studyPlan.cycles || [];
  const uniqueSubjects = getUniqueSubjects(studyPlan);

  let html = `
    <div class="legend">
        <div class="legend-title">
            <i class="fas fa-info-circle"></i>
            Legend & Study Phases
        </div>
        <div class="legend-grid">
    `;

  cycles.forEach((cycle) => {
    html += `
      <div class="legend-item">
          <div class="legend-color" style="background: ${CYCLE_TYPE_COLORS[cycle.cycleType as keyof typeof CYCLE_TYPE_COLORS]?.bg}; border: 1px solid ${CYCLE_TYPE_COLORS[cycle.cycleType as keyof typeof CYCLE_TYPE_COLORS]?.border};"></div>
          <div class="legend-text">${cycle.cycleName}</div>
      </div>
      `;
  });

  uniqueSubjects.forEach(subject => {
    const subjectName = getSubjectName(subject).toLowerCase();
    html += `
        <div class="legend-item">
            <div class="legend-color subject-block ${subjectName}"></div>
            <div class="legend-text">${getSubjectName(subject)}</div>
        </div>
        `;
  });

  html += `
        </div>
    </div>
    `;

  return html;
}

function getStructuredCSS(): string {
  return `
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lora:wght@400;700&family=Roboto:wght@400;500;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Lora', serif;
            background: white;
            font-size: 10pt;
            color: #333;
        }

        .container {
            width: 100%;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ccc;
        }

        .header h1 {
            font-family: 'Roboto', sans-serif;
            font-size: 24pt;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 12pt;
            color: #666;
        }

        .student-profile {
            margin-bottom: 20px;
            page-break-inside: avoid;
        }

        .profile-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .profile-title {
            font-family: 'Roboto', sans-serif;
            font-size: 18pt;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .profile-subtitle {
            font-size: 11pt;
            color: #666;
        }

        .profile-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .profile-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
        }

        .profile-card-title {
            font-family: 'Roboto', sans-serif;
            font-size: 12pt;
            font-weight: 700;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        .profile-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
        }

        .profile-label {
            font-weight: 700;
        }

        .calendar-section {
            width: 100%;
        }

        .section-title {
            font-family: 'Roboto', sans-serif;
            font-size: 16pt;
            font-weight: 700;
            margin-top: 30px;
            margin-bottom: 15px;
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
            page-break-before: always;
        }

        .year-calendar {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 0;
            page-break-inside: avoid;
            margin-bottom: 20px;
        }


        .month-card {
            border: none;
            border-radius: 0;
            padding: 0;
            margin: 0;
        }

        .cycle-label {
            font-size: 6pt;
            font-weight: 700;
            color: #333;
            text-align: center;
            margin-bottom: 3px;
            background: #e0e0e0;
            padding: 1px 2px;
            border-radius: 2px;
        }

        .month-header {
            text-align: center;
            margin-bottom: 4px;
            padding: 0 2px;
        }

        .month-name {
            font-family: 'Roboto', sans-serif;
            font-size: 8pt;
            font-weight: 700;
            color: #333;
        }

        .month-year {
            font-size: 6pt;
            color: #666;
        }

        .month-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            padding: 0 2px;
        }

        .day-header {
            font-family: 'Roboto', sans-serif;
            text-align: center;
            font-weight: 700;
            font-size: 5pt;
            padding: 1px;
        }

        .day-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 2px;
            font-size: 5pt;
            min-height: 8px;
        }

        .day-cell.cycle-phase-1 { background-color: #e3f2fd; }
        .day-cell.cycle-phase-2 { background-color: #e8f5e9; }
        .day-cell.cycle-phase-3 { background-color: #fff3e0; }
        .day-cell.cycle-phase-4 { background-color: #f3e5f5; }
        .day-cell.revision { background-color: #fffde7; }
        .day-cell.exam { background-color: #ffebee; }

        .month-card.cycle-c1 { background-color: rgb(227, 242, 253); border-color: rgb(59, 130, 246); }
        .month-card.cycle-c2 { background-color: rgb(232, 245, 232); border-color: rgb(34, 197, 94); }
        .month-card.cycle-c3 { background-color: rgb(252, 228, 236); border-color: rgb(236, 72, 153); }
        .month-card.cycle-c4 { background-color: rgb(255, 235, 238); border-color: rgb(239, 68, 68); }
        .month-card.cycle-c5 { background-color: rgb(243, 229, 245); border-color: rgb(168, 85, 247); }
        .month-card.cycle-c5b { background-color: rgb(243, 229, 245); border-color: rgb(168, 85, 247); }
        .month-card.cycle-c6 { background-color: rgb(225, 245, 254); border-color: rgb(6, 182, 212); }
        .month-card.cycle-c7 { background-color: rgb(255, 243, 224); border-color: rgb(245, 158, 11); }
        .month-card.cycle-c8 { background-color: rgb(241, 248, 233); border-color: rgb(132, 204, 22); }

        .month-detail {
            page-break-before: always;
        }

        .month-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .month-detail-title {
            font-family: 'Roboto', sans-serif;
            font-size: 18pt;
            font-weight: 700;
        }

        .month-detail-year {
            font-size: 14pt;
            color: #666;
        }

        .month-detail-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            border: 1px solid #ddd;
        }

        .month-day-header {
            font-family: 'Roboto', sans-serif;
            background: #f9f9f9;
            padding: 8px 4px;
            text-align: center;
            font-weight: 700;
            font-size: 9pt;
            border: 1px solid #ddd;
        }

        .month-day-cell {
            border: 1px solid #ddd;
            min-height: 70px;
            padding: 4px;
        }

        .month-day-number {
            font-weight: 700;
            font-size: 9pt;
            margin-bottom: 4px;
        }

        .subject-block {
            border-radius: 4px;
            padding: 2px 4px;
            margin: 2px 0;
            font-size: 7pt;
            font-weight: 700;
            text-align: center;
        }

        .subject-block.history { background-color: #ffcdd2; }
        .subject-block.geography { background-color: #c8e6c9; }
        .subject-block.polity { background-color: #bbdefb; }
        .subject-block.economics { background-color: #fff9c4; }
        .subject-block.science { background-color: #d1c4e9; }
        .subject-block.current-affairs { background-color: #f8bbd0; }
        .subject-block.optional { background-color: #dcedc8; }

        .week-calendar {
            page-break-before: always;
        }

        .week-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .week-title {
            font-family: 'Roboto', sans-serif;
            font-size: 16pt;
            font-weight: 700;
        }

        .week-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
        }

        .week-day {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
        }

        .week-day-header {
            text-align: center;
            margin-bottom: 10px;
        }

        .week-day-name {
            font-family: 'Roboto', sans-serif;
            font-weight: 700;
            font-size: 10pt;
        }

        .week-day-number {
            font-size: 14pt;
            font-weight: 700;
            margin-top: 2px;
        }

        .daily-tasks {
            margin-top: 10px;
        }

        .task-item {
            border-left: 3px solid;
            padding: 5px 8px;
            margin-bottom: 5px;
            font-size: 8pt;
        }

        .task-item.history { border-left-color: #e57373; }
        .task-item.geography { border-left-color: #81c784; }
        .task-item.polity { border-left-color: #64b5f6; }
        .task-item.economics { border-left-color: #fff176; }
        .task-item.science { border-left-color: #9575cd; }
        .task-item.current-affairs { border-left-color: #f06292; }
        .task-item.optional { border-left-color: #aed581; }

        .resources-table-section {
            page-break-before: always;
        }

        .subject-resources-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 9pt;
        }

        .subject-resources-table th, .subject-resources-table td {
            border: 1px solid #ddd;
            padding: 6px;
            text-align: left;
        }

        .subject-resources-table th {
            font-family: 'Roboto', sans-serif;
            font-weight: 700;
            background-color: #f9f9f9;
        }

        .subject-name {
            font-weight: 700;
        }

        .legend {
            page-break-before: always;
        }

        .legend-title {
            font-family: 'Roboto', sans-serif;
            font-size: 14pt;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .legend-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

    </style>
    `;
}


/**
 * Get unique subjects from study plan
 */
function getUniqueSubjects(studyPlan: StudyPlan): string[] {
  const subjects = new Set<string>();
  studyPlan.cycles?.forEach(cycle => {
    cycle.cycleBlocks?.forEach(block => {
      block.subjects?.forEach(subject => subjects.add(subject));
    });
  });
  return Array.from(subjects);
}

/**
 * Get subject name from subject code
 */
function getSubjectName(subjectCode: string): string {
  const subject = SubjectLoader.getSubjectByCode(subjectCode);
  return subject?.subjectName || subjectCode;
}


export function generateBirdsEyeView(studyPlan: StudyPlan): string {
  const cycles = studyPlan.cycles || [];
  let html = `<div class="year-calendar">`;
  
  const minDate = dayjs(studyPlan.start_date);
  const maxDate = dayjs(`${studyPlan.targeted_year}-08-31`);
  const endDate = maxDate.endOf('month');

  for (
      let currentDate = minDate.startOf('month');
      currentDate.isSameOrBefore(endDate, 'month');
      currentDate = currentDate.add(1, 'month')
  ) {
      const monthDate = currentDate;
      const monthName = monthDate.format('MMM'); // Use abbreviated month name

      let cycleLabel = '';
      let cycleClass = '';
      for (const cycle of cycles) {
          const cycleStart = dayjs(cycle.cycleStartDate);
          const cycleEnd = dayjs(cycle.cycleEndDate);
          if (monthDate.isBetween(cycleStart, cycleEnd, 'month', '[]')) {
              cycleLabel = cycle.cycleName || cycle.cycleType;
              cycleClass = `cycle-${cycle.cycleType.toLowerCase()}`;
              break;
          }
      }

      html += `
    <div class="month-card ${cycleClass}">
        <div class="cycle-label">${cycleLabel.replace(/ Cycle$/, '')}</div>
        <div class="month-header">
            <div class="month-name">${monthName.toUpperCase()} ${monthDate.format('YYYY')}</div>
        </div>
        <div class="month-grid">
            <div class="day-header">S</div>
            <div class="day-header">M</div>
            <div class="day-header">T</div>
            <div class="day-header">W</div>
            <div class="day-header">T</div>
            <div class="day-header">F</div>
            <div class="day-header">S</div>
    `;

      const daysInMonth = monthDate.daysInMonth();
      const firstDayOfMonth = monthDate.startOf('month').day();

      for (let j = 0; j < firstDayOfMonth; j++) {
          html += '<div class="day-cell"></div>';
      }

      for (let day = 1; day <= daysInMonth; day++) {
          html += `<div class="day-cell">${day}</div>`;
      }

      html += `
        </div>
    </div>
    `;
  }

  html += `</div>`;
  return html;
}

export function generateMonthView(studyPlan: StudyPlan): string {
  const cycles = studyPlan.cycles || [];
  const firstMonth = dayjs(studyPlan.start_date).month();
  const monthDate = dayjs().year(studyPlan.targeted_year).month(firstMonth);
  const monthName = monthDate.format('MMMM');
  const monthYear = monthDate.format('YYYY');

  let html = `
    <div class="section-title">
        <i class="fas fa-calendar-week"></i>
        ${monthName} ${monthYear}
    </div>
    <div class="month-detail">
        <div class="month-detail-header">
            <div class="month-detail-title">${monthName.toUpperCase()}</div>
            <div class="month-detail-year">${monthYear}</div>
        </div>
        <div class="month-detail-grid">
            <div class="month-day-header">Sunday</div>
            <div class="month-day-header">Monday</div>
            <div class="month-day-header">Tuesday</div>
            <div class="month-day-header">Wednesday</div>
            <div class="month-day-header">Thursday</div>
            <div class="month-day-header">Friday</div>
            <div class="month-day-header">Saturday</div>
    `;

  const daysInMonth = monthDate.daysInMonth();
  const firstDayOfMonth = monthDate.startOf('month').day();

  for (let i = 0; i < firstDayOfMonth; i++) {
    html += '<div class="month-day-cell"></div>';
  }

  for (let day = 1; day <= daysInMonth; day++) {
    const currentDate = monthDate.date(day);
    html += `
      <div class="month-day-cell">
          <div class="month-day-number">${day}</div>
      `;

    for (const cycle of cycles) {
      for (const block of cycle.cycleBlocks) {
        const blockStart = dayjs(block.block_start_date);
        const blockEnd = dayjs(block.block_end_date);

        if (currentDate.isBetween(blockStart, blockEnd, 'day', '[]')) {
          for (const subject of block.subjects) {
            const subjectName = getSubjectName(subject).toLowerCase();
            html += `<div class="subject-block ${subjectName}">${getSubjectName(subject)}</div>`;
          }
        }
      }
    }

    html += '</div>';
  }

  html += `
        </div>
    </div>
    `;

  return html;
}

export function generateWeekView(studyPlan: StudyPlan): string {
  const cycles = studyPlan.cycles || [];
  const firstWeekStart = dayjs(studyPlan.start_date).startOf('week');

  let html = `
    <div class="section-title">
        <i class="fas fa-calendar-day"></i>
        Week of ${firstWeekStart.format('MMMM DD-DD, YYYY')} - Daily Tasks
    </div>
    <div class="week-calendar">
        <div class="week-header">
            <div class="week-title">Week 1: ${firstWeekStart.format('MMMM DD-DD, YYYY')}</div>
            <div class="week-nav">
                <button class="nav-btn"><i class="fas fa-chevron-left"></i></button>
                <button class="nav-btn"><i class="fas fa-chevron-right"></i></button>
            </div>
        </div>
        <div class="week-grid">
    `;

  for (let i = 0; i < 7; i++) {
    const currentDate = firstWeekStart.add(i, 'day');
    html += `
      <div class="week-day">
          <div class="week-day-header">
              <div class="week-day-name">${currentDate.format('dddd')}</div>
              <div class="week-day-number">${currentDate.format('DD')}</div>
          </div>
          <div class="daily-tasks">
      `;

    for (const cycle of cycles) {
      for (const block of cycle.cycleBlocks) {
        const blockStart = dayjs(block.block_start_date);
        const blockEnd = dayjs(block.block_end_date);

        if (currentDate.isBetween(blockStart, blockEnd, 'day', '[]')) {
          for (const subject of block.subjects) {
            const subjectName = getSubjectName(subject).toLowerCase();
            html += `
              <div class="task-item ${subjectName}">
                  <div class="task-description">${getSubjectName(subject)} - ${block.block_title}</div>
              </div>
              `;
          }
        }
      }
    }

    html += `
          </div>
      </div>
      `;
  }

  html += `
        </div>
    </div>
    `;

  return html;
}
